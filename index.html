<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>МЯКОТЬ OCR v4 ☢️</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #0f0; padding: 20px; text-align: center; }
    h1 { color: #0f0; text-shadow: 0 0 10px #0f0; }
    .calc { max-width: 800px; margin: auto; background: #111; padding: 25px; border: 2px solid #0f0; border-radius: 15px; }
    input[type="file"], input[type="number"] { background: #222; color: #0f0; border: 1px solid #0f0; padding: 8px; border-radius: 5px; }
    button { background: #0f0; color: #000; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px; }
    button:hover { background: #0c0; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #0f0; padding: 10px; text-align: center; }
    th { background: #002200; }
    .total { font-size: 1.8em; font-weight: bold; color: #0f0; text-align: center; margin: 20px 0; text-shadow: 0 0 8px #0f0; }
    .price-input { display: flex; justify-content: space-between; margin: 8px 0; }
    canvas { border: 1px dashed #0f0; margin: 10px 0; max-width: 100%; }
    #status { color: #ff0; margin: 10px; }
    .footer { margin-top: 30px; font-size: 0.9em; color: #0a0; }
  </style>
</head>
<body>
  <h1>☢️ МЯКОТЬ OCR КАЛЬКУЛЯТОР v4 ☢️</h1>
  
  <div class="calc">
    <div class="price-input">
      <label>API Key (OCR.space):</label>
      <input type="text" id="apiKey" placeholder="K83417785288957" />
    </div>

    <div id="prices">
      <!-- Цены загрузятся здесь -->
    </div>
    <button onclick="savePrices()">Сохранить цены</button>

    <hr style="border: 1px dashed #0f0;">

    <input type="file" id="screenshot" accept="image/*" />
    <button onclick="processWithOCR()">РАСПОЗНАТЬ СКРИН (OCR)</button>
    <div id="status"></div>

    <div id="result" style="display:none;">
      <canvas id="debugCanvas"></canvas>
      <table id="table"></table>
      <div class="total" id="total"></div>
    </div>
  </div>

  <div class="footer">v4.0 | OCR.space + JS | by Grok | 2025</div>

  <script>
    const API_URL = 'https://api.ocr.space/parse/image';
    const templates = [
      { name: "Куборбуза", color: "red" },
      { name: "Спиртень", color: "purple" },
      { name: "Мятноплод", color: "green" },
      { name: "Сластена", color: "blue" },
      { name: "Лимонник", color: "yellow" },
      { name: "Солевик", color: "white" }
    ];
    let prices = {};

    // Инициализация
    function init() {
      const div = document.getElementById("prices");
      templates.forEach((t, i) => {
        div.innerHTML += `<div class="price-input"><label><span style="color:${t.color}">● ${t.name}:</span></label><input type="number" id="price${i}" value="0" /></div>`;
      });
      loadPrices();
    }

    function savePrices() {
      templates.forEach((t, i) => prices[t.name] = parseInt(document.getElementById(`price${i}`).value) || 0);
      localStorage.setItem("pulp_prices", JSON.stringify(prices));
      alert("Цены сохранены!");
    }

    function loadPrices() {
      const saved = localStorage.getItem("pulp_prices");
      if (saved) {
        prices = JSON.parse(saved);
        templates.forEach((t, i) => document.getElementById(`price${i}`).value = prices[t.name] || 0);
      }
    }

    // Основная обработка
    async function processWithOCR() {
      const file = document.getElementById("screenshot").files[0];
      if (!file) return alert("Загрузи скрин!");
      if (Object.keys(prices).length === 0) return alert("Укажи цены!");

      const apiKey = document.getElementById("apiKey").value;
      if (!apiKey) return alert("Вставь API-ключ!");

      document.getElementById("status").innerText = "Обрабатываю... (OCR + цвета)";
      const img = await loadImage(file);
      const canvas = document.getElementById("debugCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width; canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const cells = detectGrid(img);
      const results = [];

      for (let cell of cells) {
        // 1. Цвет для типа
        const match = getColorType(cell.canvas);
        if (!match) continue;

        // 2. OCR для числа (crop правый верх)
        const crop = cropNumberArea(cell.canvas);
        const countText = await ocrRequest(crop, apiKey);
        const count = parseNumber(countText) || 0;

        results.push({ type: match.name, count, price: prices[match.name] || 0 });
        drawCell(ctx, cell, match.name, count);
      }

      displayResults(results);
      document.getElementById("status").innerText = "Готово!";
    }

    // Детекция сетки 2x3
    function detectGrid(img) {
      const cells = [];
      const w = img.width / 3;
      const h = img.height / 2;
      for (let row = 0; row < 2; row++) {
        for (let col = 0; col < 3; col++) {
          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const cctx = canvas.getContext("2d");
          cctx.drawImage(img, col * w, row * h, w, h, 0, 0, w, h);
          cells.push({ canvas, x: col * w, y: row * h, w, h });
        }
      }
      return cells;
    }

    // Анализ цвета (RGB среднее)
    function getColorType(canvas) {
      const ctx = canvas.getContext("2d");
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < data.length; i += 4) {
        if (data[i + 3] > 100) { r += data[i]; g += data[i + 1]; b += data[i + 2]; count++; }
      }
      if (count === 0) return null;
      r /= count; g /= count; b /= count;
      return templates.find(t => {
        if (t.color === "red" && r > 180 && g < 120 && b < 120) return true;
        if (t.color === "blue" && r < 120 && g < 120 && b > 160) return true;
        if (t.color === "green" && r < 120 && g > 160 && b < 120) return true;
        if (t.color === "yellow" && r > 160 && g > 160 && b < 120) return true;
        if (t.color === "purple" && r > 100 && g < 100 && b > 140) return true;
        if (t.color === "white" && r > 200 && g > 200 && b > 200) return true;
        return false;
      });
    }

    // Crop для числа (правый верх, 100x50)
    function cropNumberArea(canvas) {
      const crop = document.createElement("canvas");
      crop.width = 100; crop.height = 50;
      const ctx = crop.getContext("2d");
      ctx.drawImage(canvas, canvas.width - 100, 0, 100, 50, 0, 0, 100, 50);
      return crop.toDataURL('image/png');
    }

    // Запрос к OCR.space
    async function ocrRequest(imageDataUrl, apiKey) {
      const formData = new FormData();
      formData.append('base64Image', imageDataUrl.split(',')[1]);
      formData.append('apikey', apiKey);
      formData.append('language', 'eng');
      formData.append('isOverlayRequired', false);

      const response = await fetch(API_URL, { method: 'POST', body: formData });
      const json = await response.json();
      return json.ParsedResults[0]?.ParsedText || '';
    }

    // Парсинг числа из текста (e.g. "16x" → 16)
    function parseNumber(text) {
      const match = text.match(/(\d+)x?/i);
      return match ? parseInt(match[1]) : 0;
    }

    function drawCell(ctx, cell, name, count) {
      ctx.strokeStyle = "#0f0"; ctx.lineWidth = 3;
      ctx.strokeRect(cell.x, cell.y, cell.w, cell.h);
      ctx.fillStyle = "#0f0"; ctx.font = "20px Arial";
      ctx.fillText(`${name}: ${count}x`, cell.x + 10, cell.y + 30);
    }

    function displayResults(results) {
      const table = document.getElementById("table");
      table.innerHTML = `<tr><th>Мякоть</th><th>Кол-во</th><th>Цена/шт</th><th>Итого</th></tr>`;
      let total = 0;
      results.forEach(r => {
        const sum = r.count * r.price;
        total += sum;
        table.innerHTML += `<tr><td>${r.type}</td><td>${r.count}</td><td>${r.price}</td><td>${sum.toLocaleString()}</td></tr>`;
      });
      document.getElementById("total").innerText = `ИТОГО: ${total.toLocaleString()} руб`;
      document.getElementById("result").style.display = "block";
    }

    function loadImage(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }

    init();
  </script>
</body>
</html>
