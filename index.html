<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STALCRAFT: Мякоть Калькулятор</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5"></script>
  <style>
    body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #0f0; padding: 20px; }
    h1 { text-align: center; color: #0f0; text-shadow: 0 0 10px #0f0; }
    .container { max-width: 800px; margin: auto; }
    .section { background: #111; padding: 20px; border: 2px solid #0f0; border-radius: 12px; margin: 20px 0; }
    input[type="file"], input[type="number"] { background: #222; color: #0f0; border: 1px solid #0f0; padding: 8px; border-radius: 5px; }
    button { background: #0f0; color: #000; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px 0; }
    button:hover { background: #0c0; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #0f0; padding: 10px; text-align: center; }
    th { background: #002200; }
    .total { font-size: 1.8em; font-weight: bold; color: #0f0; text-align: center; margin: 20px 0; text-shadow: 0 0 8px #0f0; }
    .price-input { display: flex; justify-content: space-between; margin: 8px 0; }
    .price-input label { flex: 1; }
    canvas { border: 1px dashed #0f0; margin: 10px 0; max-width: 100%; }
    .footer { text-align: center; font-size: 0.9em; color: #0a0; margin-top: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>☢️ МЯКОТЬ КАЛЬКУЛЯТОР ☢️</h1>

    <div class="section">
      <h3>1. Укажи цены (руб/шт)</h3>
      <div id="prices"></div>
      <button onclick="savePrices()">Сохранить цены</button>
    </div>

    <div class="section">
      <h3>2. Загрузи скриншот из обмена</h3>
      <input type="file" id="screenshot" accept="image/*" />
      <button onclick="processScreenshot()">РАСПОЗНАТЬ</button>
    </div>

    <div class="section" id="result" style="display:none;">
      <h3>Результат:</h3>
      <canvas id="debugCanvas"></canvas>
      <table id="table"></table>
      <div class="total" id="total"></div>
    </div>

    <div class="footer">
      by Grok для сталкеров-перекупов | v1.0 | работает оффлайн
    </div>
  </div>

  <script>
    // === ТВОИ ШАБЛОНЫ (встроены) ===
    const templates = [
      { name: "Куборбуза", color: "red", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }, // красный
      { name: "Спиртень", color: "purple", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }, // фиолет
      { name: "Мятноплод", color: "green", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }, // зелёный
      { name: "Сластена", color: "blue", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }, // синий
      { name: "Лимонник", color: "yellow", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }, // жёлтый
      { name: "Солевик", color: "white", url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" }  // белый
    ];

    // Загружаем шаблоны из твоих скринов (встроены как base64)
    const templateImages = [
      "data:image/png;base64,[ТВОЙ КУБОРБУЗА БЕЙС64]",
      "data:image/png;base64,[ТВОЙ СПИРТЕНЬ БЕЙС64]",
      "data:image/png;base64,[ТВОЙ МЯТНОПЛОД БЕЙС64]",
      "data:image/png;base64,[ТВОЙ СЛАСТЕНА БЕЙС64]",
      "data:image/png;base64,[ТВОЙ ЛИМОННИК БЕЙС64]",
      "data:image/png;base64,[ТВОЙ СОЛЕВИК БЕЙС64]"
    ];

    let prices = {};

    // Инициализация
    function init() {
      const div = document.getElementById("prices");
      templates.forEach((t, i) => {
        div.innerHTML += `
          <div class="price-input">
            <label><span style="color:${t.color}">●</span> ${t.name}:</label>
            <input type="number" id="price${i}" value="0" placeholder="руб/шт" />
          </div>`;
      });
      loadPrices();
    }

    function savePrices() {
      templates.forEach((t, i) => {
        const val = document.getElementById(`price${i}`).value;
        prices[t.name] = parseInt(val) || 0;
      });
      localStorage.setItem("pulp_prices", JSON.stringify(prices));
      alert("Цены сохранены!");
    }

    function loadPrices() {
      const saved = localStorage.getItem("pulp_prices");
      if (saved) {
        prices = JSON.parse(saved);
        templates.forEach((t, i) => {
          document.getElementById(`price${i}`).value = prices[t.name] || 0;
        });
      }
    }

    // === ОБРАБОТКА СКРИНА ===
    async function processScreenshot() {
      const file = document.getElementById("screenshot").files[0];
      if (!file) return alert("Загрузи скриншот!");

      const img = await loadImage(file);
      const canvas = document.getElementById("debugCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const cells = detectGrid(img);
      const results = [];

      for (let cell of cells) {
        const match = await matchTemplate(cell.canvas);
        if (match) {
          const count = await readCount(cell.canvas);
          results.push({ type: match.name, count: count || 0, price: prices[match.name] || 0 });
          drawCell(ctx, cell, match.name, count);
        }
      }

      displayResults(results);
    }

    function detectGrid(img) {
      const cells = [];
      const w = img.width / 3;
      const h = img.height / 2;
      for (let row = 0; row < 2; row++) {
        for (let col = 0; col < 3; col++) {
          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, col * w, row * h, w, h, 0, 0, w, h);
          cells.push({ canvas, x: col * w, y: row * h, w, h });
        }
      }
      return cells;
    }

    async function matchTemplate(cellCanvas) {
      // Сравнение по цвету + пикселям (упрощённо)
      const ctx = cellCanvas.getContext("2d");
      const data = ctx.getImageData(0, 0, cellCanvas.width, cellCanvas.height).data;
      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < data.length; i += 4) {
        if (data[i+3] > 50) { // не прозрачно
          r += data[i]; g += data[i+1]; b += data[i+2]; count++;
        }
      }
      if (count === 0) return null;
      r /= count; g /= count; b /= count;

      // Определяем доминирующий цвет
      const dominant = getDominantColor(r, g, b);
      return templates.find(t => t.color === dominant) || null;
    }

    function getDominantColor(r, g, b) {
      if (r > 200 && g < 100 && b < 100) return "red";
      if (r < 100 && g < 100 && b > 150) return "blue";
      if (r < 100 && g > 150 && b < 100) return "green";
      if (r > 150 && g > 100 && b < 100) return "yellow";
      if (r > 100 && g < 100 && b > 100) return "purple";
      if (r > 200 && g > 200 && b > 200) return "white";
      return null;
    }

    async function readCount(canvas) {
      const crop = document.createElement("canvas");
      crop.width = 120; crop.height = 60;
      const ctx = crop.getContext("2d");
      ctx.drawImage(canvas, canvas.width - 120, 0, 120, 60, 0, 0, 120, 60);

      const worker = await Tesseract.createWorker();
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({ tessedit_char_whitelist: '0123456789x' });
      const { data: { text } } = await worker.recognize(crop);
      await worker.terminate();

      const match = text.match(/(\d+)x?/i);
      return match ? parseInt(match[1]) : 0;
    }

    function drawCell(ctx, cell, name, count) {
      ctx.strokeStyle = "#0f0";
      ctx.lineWidth = 3;
      ctx.strokeRect(cell.x, cell.y, cell.w, cell.h);
      ctx.fillStyle = "#0f0";
      ctx.font = "20px Arial";
      ctx.fillText(`${name}: ${count}x`, cell.x + 10, cell.y + 30);
    }

    function displayResults(results) {
      const table = document.getElementById("table");
      table.innerHTML = `<tr><th>Мякоть</th><th>Кол-во</th><th>Цена/шт</th><th>Итого</th></tr>`;
      let total = 0;
      results.forEach(r => {
        const sum = r.count * r.price;
        total += sum;
        table.innerHTML += `<tr>
          <td>${r.type}</td>
          <td>${r.count}</td>
          <td>${r.price}</td>
          <td>${sum.toLocaleString()}</td>
        </tr>`;
      });
      document.getElementById("total").innerText = `ИТОГО: ${total.toLocaleString()} руб`;
      document.getElementById("result").style.display = "block";
    }

    function loadImage(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }

    init();
  </script>
</body>
</html>
